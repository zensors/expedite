steps:
  - label: ":mocha: Testing"
    commands:
      - "echo '--- Setting up'"
      - "mkdir -p /test"
      - "cp -R . /test"
      - "cd /test"
      - "cp .yarnrc.ci.yml ~/.yarnrc.yml"
      - "echo '--- Installing Packages'"
      - "yarn install --immutable"
      - "echo '+++ Running Tests'"
      - "yarn test"
    plugins:
      - docker#v3.7.0:
          image: "node:lts"
          propagate-environment: true

  - wait

  - label: ":npm: Building and Publishing Module"
    commands:
      - "echo '--- Setting up'"
      - "mkdir -p /build"
      - "cp -R . /build"
      - "cd /build"
      - "cp .yarnrc.ci.yml ~/.yarnrc.yml"
      - "echo '--- Installing Packages'"
      - "yarn install --immutable"
      - "echo '+++ Publishing'"
      - "yarn npm publish"
    plugins:
      - docker#v3.7.0:
          image: "node:lts"
          propagate-environment: true
    if: build.branch == "master"
